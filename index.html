<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>乳品研发计算器 v13.0</title>
    
    <!-- PWA 配置 -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FFFFFF">
    
    <!-- 图标 -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%230052D9'/%3E%3Cpath d='M50 20 C50 20 30 50 30 70 A20 20 0 0 0 70 70 C70 50 50 20 50 20 Z' fill='white'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%230052D9'/%3E%3Cpath d='M50 20 C50 20 30 50 30 70 A20 20 0 0 0 70 70 C70 50 50 20 50 20 Z' fill='white'/%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 44px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --primary: #0052D9;
            --bg: #F5F7FA;
        }
        body {
            background-color: var(--bg);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Helvetica, sans-serif;
            -webkit-tap-highlight-color: transparent;
            color: #1F2937;
            overscroll-behavior-y: none;
            user-select: none;
        }
        input { user-select: text; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        /* 玻璃态头部 */
        .header-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: saturate(180%) blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        
        /* 适配不同机型的顶部高度 */
        .pt-safe { padding-top: calc(var(--safe-top) + 8px); }
        .pb-safe { padding-bottom: calc(var(--safe-bottom) + 60px); }
        .tap-active:active { transform: scale(0.96); opacity: 0.8; transition: transform 0.1s; }
        
        /* 列表项 */
        .list-row {
            display: flex; align-items: center; background: #fff; border-bottom: 1px solid #F3F4F6;
            padding: 12px 14px; position: relative; transition: background-color 0.2s;
        }
        .list-row:last-child { border-bottom: none; }
        .list-row.locked-bg { background-color: #F9FAFB; }
        .list-row.post-add-bg { background-color: #F0F9FF; border-left: 3px solid #3B82F6; }
        
        /* 步进器 */
        .stepper-btn {
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            background: #F3F4F6; color: #4B5563; border-radius: 10px; font-weight: bold; font-size: 18px;
            flex-shrink: 0;
        }
        .stepper-btn:active { background: #E5E7EB; color: #111827; }
        
        .input-focus:focus-within { background: #fff; box-shadow: 0 0 0 2px var(--primary); z-index: 10; }
        .cost-bar { position: absolute; bottom: 0; left: 0; height: 3px; background: #10B981; opacity: 0.4; }

        /* Tab Bar */
        .tab-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0,0,0,0.05);
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;
            padding-bottom: calc(env(safe-area-inset-bottom) + 4px);
            height: calc(56px + env(safe-area-inset-bottom));
            z-index: 50;
        }
        .tab-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #9CA3AF; transition: all 0.2s; gap: 2px;
        }
        .tab-item.active { color: #0052D9; }
        .tab-item .icon-box { padding: 4px 16px; border-radius: 16px; transition: background 0.2s; }
        .tab-item.active .icon-box { background: #EFF6FF; }
        .tab-item .label { font-size: 10px; font-weight: 600; }

        /* Checkbox */
        .chk-round { width: 22px; height: 22px; border-radius: 50%; border: 2px solid #D1D5DB; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .chk-round.checked { background: #0052D9; border-color: #0052D9; }
        .chk-round.checked::after { content: ''; width: 9px; height: 5px; border-left: 2px solid white; border-bottom: 2px solid white; transform: rotate(-45deg) translate(1px, -1px); }

        /* Toast */
        .toast-container {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(31, 41, 55, 0.9); color: white; padding: 12px 24px; border-radius: 50px;
            font-size: 14px; font-weight: bold; z-index: 100; pointer-events: none;
            opacity: 0; transition: opacity 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            backdrop-filter: blur(4px); text-align: center; white-space: nowrap;
        }
        .toast-show { opacity: 1; }
        
        /* Toggle Switch */
        .toggle-sm { position: relative; width: 32px; height: 18px; background: #E5E7EB; border-radius: 20px; transition: all 0.2s; flex-shrink: 0; }
        .toggle-sm.checked { background: #0052D9; }
        .toggle-sm::after { content:''; position: absolute; left: 2px; top: 2px; width: 14px; height: 14px; background: white; border-radius: 50%; transition: all 0.2s; }
        .toggle-sm.checked::after { transform: translateX(14px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, Fragment } = React;
        const vibrate = () => { if (navigator.vibrate) navigator.vibrate(10); };

        const Icon = ({ d, size = 24, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d} /></svg>
        );
        const ICONS = {
            Flask: "M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2M8.5 2h7M7 16h10",
            Brain: "M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z",
            Tools: "M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z",
            Folder: "M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z",
            Lock: "M7 11V7a5 5 0 0 1 10 0v4M3 11h18v11H3z", 
            Unlock: "M7 11V7a5 5 0 0 1 9.9-1M3 11h18v11H3z", 
            X: "M18 6 6 18M6 6 12 12",
            Plus: "M12 5v14M5 12h14",
            Share: "M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8M16 6l-4-4-4 4M12 2v13",
            Drop: "M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z",
            Trash: "M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",
            Bolt: "M13 2L3 14h9l-1 8 10-12h-9l1-8z",
            Microscope: "M6 18h8M3 22h18M14 22a7 7 0 1 0 0-14h-1M9 14h2M9 12a2 2 0 0 1-2-2V6h6v4a2 2 0 0 1-2 2ZM12 6V3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3",
            Edit: "M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",
            Target: "M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 16a6 6 0 1 1 6-6 6 6 0 0 1-6 6z",
            Download: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3",
            Save: "M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2zM17 21v-8H7v8M7 3v5h8",
            EditPen: "M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"
        };

        const DEFAULT_INGREDIENTS = [
            { id: 'rm', name: '生牛乳', fat: 3.8, protein: 3.1, ts: 12.5, price: 4.5, sweet: 0, visc: 1.0 },
            { id: 'conc', name: '浓缩奶', fat: 8.0, protein: 7.0, ts: 26.0, price: 9.0, sweet: 0, visc: 2.5 },
            { id: 'cr', name: '稀奶油38', fat: 38.0, protein: 2.2, ts: 45.0, price: 35.0, sweet: 0, visc: 1.2 },
            { id: 'smp', name: '脱脂粉', fat: 0.8, protein: 34.0, ts: 96.0, price: 28.0, sweet: 0, visc: 5.0 },
            { id: 'wmp', name: '全脂粉', fat: 26.0, protein: 24.0, ts: 96.0, price: 32.0, sweet: 0, visc: 4.5 },
            { id: 'wpc', name: 'WPC80', fat: 6.0, protein: 80.0, ts: 95.0, price: 65.0, sweet: 0, visc: 8.0 },
            { id: 'suc', name: '白砂糖', fat: 0.0, protein: 0.0, ts: 99.8, price: 6.5, sweet: 1.0, visc: 0.5 },
            { id: 'ery', name: '赤藓糖醇', fat: 0.0, protein: 0.0, ts: 99.0, price: 15.0, sweet: 0.65, visc: 0.2 },
            { id: 'stab', name: '复配稳定剂', fat: 0.0, protein: 0.0, ts: 95.0, price: 45.0, sweet: 0, visc: 100.0 },
            { id: 'jam', name: '果酱', fat: 0.0, protein: 0.3, ts: 45.0, price: 12.0, sweet: 0.4, isPost: true, visc: 20.0 },
            { id: 'wat', name: '工艺水', fat: 0.0, protein: 0.0, ts: 0.0, price: 0.005, sweet: 0, visc: 0 },
        ];

        const Toast = ({ msg, visible }) => (
            <div className={`toast-container ${visible ? 'toast-show' : ''}`}>{msg}</div>
        );

        const NumInput = ({ label, value, onChange, suffix, enabled, onToggle, className }) => (
            <div className={`bg-white rounded-xl p-3 flex flex-col justify-center border transition-colors ${enabled===false ? 'opacity-50 border-gray-100' : 'border-blue-100'} ${className}`}>
                <div className="flex justify-between items-center mb-1">
                    <div className="text-[10px] text-gray-400 font-bold uppercase">{label}</div>
                    {onToggle && (
                        <div className={`toggle-sm ${enabled?'checked':''}`} onClick={(e) => { e.stopPropagation(); onToggle(); }}></div>
                    )}
                </div>
                <div className="flex items-center">
                    <input type="number" value={value} onChange={onChange} disabled={enabled===false} className="w-full bg-transparent font-mono text-2xl font-bold outline-none text-gray-800" placeholder="-"/>
                    {suffix && <span className="text-xs text-gray-400 ml-1">{suffix}</span>}
                </div>
            </div>
        );

        const StepperInput = ({ value, onChange, disabled }) => {
            const handleStep = (delta) => {
                if (disabled) return;
                vibrate();
                const safeVal = parseFloat(value) || 0;
                onChange({ target: { value: Math.max(0, safeVal + delta).toFixed(1) } });
            };
            return (
                <div className={`flex items-center gap-1 h-12 rounded-xl ${disabled ? '' : 'bg-blue-50/50 input-focus'}`}>
                    <button onClick={(e) => {e.stopPropagation(); handleStep(-1)}} disabled={disabled} className="stepper-btn">-</button>
                    <input type="number" value={value} disabled={disabled} onChange={onChange} className={`flex-1 text-center font-mono text-xl font-bold bg-transparent outline-none ${disabled ? 'text-gray-400' : 'text-blue-700'}`} />
                    <button onClick={(e) => {e.stopPropagation(); handleStep(1)}} disabled={disabled} className="stepper-btn">+</button>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('ai'); 
            const [library, setLibrary] = useState(() => JSON.parse(localStorage.getItem('v13_lib')) || DEFAULT_INGREDIENTS);
            const [formula, setFormula] = useState(() => JSON.parse(localStorage.getItem('v13_formula')) || [{...DEFAULT_INGREDIENTS[0], uuid:'1', weight:850, locked:false}, {...DEFAULT_INGREDIENTS[5], uuid:'2', weight:60, locked:true}]);
            const [targets, setTargets] = useState(() => JSON.parse(localStorage.getItem('v13_targets')) || {fat:3.5, pro:3.0, ts:12.0, se: 7.0, enableTs: true, enableSe: true});
            const [batchSize, setBatchSize] = useState(() => parseFloat(localStorage.getItem('v13_batch')) || 1000);
            const [productMode, setProductMode] = useState(() => localStorage.getItem('v13_pmode') || 'liquid');
            const [savedRecipes, setSavedRecipes] = useState(() => JSON.parse(localStorage.getItem('v13_recipes')) || []);
            const [viewMode, setViewMode] = useState('calc'); 
            const [isLocked, setIsLocked] = useState(false);
            const [baseView, setBaseView] = useState(true);
            const [showAdd, setShowAdd] = useState(false);
            const [editId, setEditId] = useState(null);
            const [toast, setToast] = useState({ show: false, msg: '' });
            const [isSolving, setIsSolving] = useState(false);
            const [genSelected, setGenSelected] = useState([]);
            const [fossReadings, setFossReadings] = useState(() => JSON.parse(localStorage.getItem('v13_foss')) || { fat: 0, protein: 0, ts: 0 });
            const [acidity, setAcidity] = useState(() => JSON.parse(localStorage.getItem('v13_acidity')) || { t: 70 });
            const [cultureCalc, setCultureCalc] = useState(() => JSON.parse(localStorage.getItem('v13_culture')) || { dcuPerTon: 50, pouchSize: 50, pouchWeight: 10 });

            useEffect(() => {
                localStorage.setItem('v13_lib', JSON.stringify(library));
                localStorage.setItem('v13_formula', JSON.stringify(formula));
                localStorage.setItem('v13_targets', JSON.stringify(targets));
                localStorage.setItem('v13_batch', batchSize);
                localStorage.setItem('v13_recipes', JSON.stringify(savedRecipes));
                localStorage.setItem('v13_pmode', productMode);
                localStorage.setItem('v13_foss', JSON.stringify(fossReadings));
                localStorage.setItem('v13_acidity', JSON.stringify(acidity));
                localStorage.setItem('v13_culture', JSON.stringify(cultureCalc));
            }, [library, formula, targets, batchSize, savedRecipes, productMode, fossReadings, acidity, cultureCalc]);

            const showToast = (msg) => { setToast({ show: true, msg }); setTimeout(() => setToast({ show: false, msg: '' }), 2000); };
            const isYogurt = productMode === 'yogurt';
            
            const res = useMemo(() => {
                let W=0, F=0, P=0, T=0, C=0, S=0, V=0;
                const activeItems = (isYogurt && baseView) ? formula.filter(i => !i.isPost) : formula;
                
                activeItems.forEach(i => {
                    const w = parseFloat(i.weight)||0;
                    W+=w; F+=w*(i.fat||0); P+=w*(i.protein||0); T+=w*(i.ts||0); C+=w*(i.price||0); S+=w*(i.sweet||0); V+=w*(i.visc||0);
                });
                const sW = W || 1;
                return { w: W, fat: F/sW, pro: P/sW, ts: T/sW, pf: F>0?P/F:0, cost: C, costPerKg: C/sW, se: S/sW, tex: V/sW };
            }, [formula, isYogurt, baseView]);

            const updateItem = (uuid, k, v) => setFormula(formula.map(i => i.uuid===uuid ? {...i, [k]: v} : i));
            const delItem = (uuid) => { vibrate(); setFormula(formula.filter(i => i.uuid!==uuid)); };
            const addItem = (item) => { vibrate(); setFormula([...formula, {...item, uuid: Date.now().toString(), weight:0}]); setShowAdd(false); showToast("已添加"); };
            
            const normalize = () => {
                vibrate();
                if(res.w === 0) return;
                const r = batchSize / res.w;
                setFormula(formula.map(i => {
                    if (isYogurt && baseView && i.isPost) return i; 
                    return {...i, weight: parseFloat((i.weight*r).toFixed(2))};
                }));
                showToast("已归一化");
            };

            const balanceWater = () => {
                vibrate();
                let wIdx = formula.findIndex(i => i.id === 'wat');
                if (wIdx === -1) wIdx = formula.findIndex(i => i.name.includes('水'));
                if (wIdx === -1) {
                    const waterLib = library.find(i => i.id === 'wat') || { id: 'wat', name: '工艺水', fat:0, protein:0, ts:0, price:0.005 };
                    const newWater = { ...waterLib, uuid: Date.now().toString(), weight: 0 };
                    const newF = [...formula, newWater];
                    const activeF = (isYogurt && baseView) ? newF.filter(i => !i.isPost) : newF;
                    const others = activeF.reduce((acc, i) => i.uuid !== newWater.uuid ? acc+(parseFloat(i.weight)||0) : acc, 0);
                    const need = batchSize - others;
                    if (need < 0) { setFormula(newF); return showToast(`已添水,但超重 ${Math.abs(need).toFixed(1)}g`); }
                    newF[newF.length-1].weight = parseFloat(need.toFixed(2));
                    setFormula(newF);
                    return showToast("自动补水完成");
                }
                if (isYogurt && baseView && formula[wIdx].isPost) return showToast("水为后添加，请切成品模式");
                const activeF = (isYogurt && baseView) ? formula.filter(i => !i.isPost) : formula;
                const others = activeF.reduce((acc, i, idx) => i.uuid!==formula[wIdx].uuid ? acc+(parseFloat(i.weight)||0) : acc, 0);
                const need = batchSize - others;
                if (need < 0) return showToast(`超重 ${Math.abs(need).toFixed(1)}g`);
                const newF = [...formula]; newF[wIdx].weight = parseFloat(need.toFixed(2));
                setFormula(newF);
                showToast("补水完成");
            };

            const copyReport = () => {
                const txt = `配方\n--------\n` + formula.map(i=>`${i.name}: ${i.weight}g`).join('\n') + `\n--------\n总:${res.w.toFixed(1)}g\nF:${res.fat.toFixed(2)}% P:${res.pro.toFixed(2)}%`;
                navigator.clipboard.writeText(txt).then(()=>showToast("已复制"));
            };
            
            const calcCultureWeight = () => { const batchInTon = batchSize / 1000000; const totalDCU = batchInTon * cultureCalc.dcuPerTon; const grams = (totalDCU / cultureCalc.pouchSize) * cultureCalc.pouchWeight; return isNaN(grams) ? 0 : grams; };

            // --- Gradient Descent Solver ---
            const autoSolve = (mode) => {
                vibrate();
                const unlocked = mode === 'gen' ? genSelected.map(id=>library.find(l=>l.id===id)) : formula.filter(i => !i.locked);
                if (mode === 'gen' && unlocked.length === 0) return showToast("请至少选择一种原料");
                if (mode === 'balance' && unlocked.length === 0) return showToast("请解锁部分原料");

                setIsSolving(true);
                setTimeout(() => {
                    const fixedWeight = mode === 'gen' ? 0 : formula.reduce((acc, i) => i.locked ? acc + (parseFloat(i.weight)||0) : acc, 0);
                    const targetW = batchSize - fixedWeight;
                    
                    if(targetW <= 0) { setIsSolving(false); return showToast("锁定原料已满/超重"); }

                    let currentItems = unlocked.map((item) => ({ ...item, weight: targetW / unlocked.length }));
                    const iterations = 2000;
                    let step = targetW * 0.05; 
                    const decay = 0.995; 
                    let baseFat=0, basePro=0, baseTS=0, baseSE=0;

                    if(mode === 'balance') {
                        formula.forEach(i => {
                            if(i.locked) {
                                const w = parseFloat(i.weight)||0;
                                baseFat += w * (i.fat||0); basePro += w * (i.protein||0); baseTS += w * (i.ts||0); baseSE += w * (i.sweet||0);
                            }
                        });
                    }

                    let bestError = Infinity;
                    let bestWeights = currentItems.map(i => i.weight);

                    for (let k = 0; k < iterations; k++) {
                        const idx1 = Math.floor(Math.random() * currentItems.length);
                        let idx2 = Math.floor(Math.random() * currentItems.length);
                        while(idx1 === idx2 && currentItems.length > 1) idx2 = Math.floor(Math.random() * currentItems.length);

                        const move = (Math.random() - 0.5) * step; 
                        if (currentItems[idx1].weight - move >= 0 && currentItems[idx2].weight + move >= 0) {
                            currentItems[idx1].weight -= move;
                            currentItems[idx2].weight += move;
                            
                            let varFat=0, varPro=0, varTS=0, varSE=0;
                            currentItems.forEach(i => {
                                varFat += i.weight * (i.fat||0); varPro += i.weight * (i.protein||0); varTS += i.weight * (i.ts||0); varSE += i.weight * (i.sweet||0);
                            });

                            const totalFat = (baseFat + varFat) / batchSize * 100;
                            const totalPro = (basePro + varPro) / batchSize * 100;
                            const totalTS = (baseTS + varTS) / batchSize * 100;
                            const totalSE = (baseSE + varSE) / batchSize * 100;

                            let err = Math.abs(totalFat - targets.fat)*10 + Math.abs(totalPro - targets.pro)*10;
                            if(targets.enableTs) err += Math.abs(totalTS - targets.ts)*2;
                            if(isYogurt && targets.enableSe) err += Math.abs(totalSE - targets.se)*3;

                            if (err < bestError) {
                                bestError = err;
                                bestWeights = currentItems.map(i => i.weight);
                            } else {
                                if (k % 10 === 0) currentItems.forEach((i, idx) => i.weight = bestWeights[idx]);
                            }
                        }
                        step *= decay;
                    }

                    if (mode === 'gen') {
                        const newF = unlocked.map((item, idx) => ({ ...item, uuid: Math.random().toString(36).substr(2,9), weight: parseFloat(bestWeights[idx].toFixed(2)), locked: false }));
                        setFormula(newF); setGenSelected([]);
                    } else {
                        let uIdx = 0;
                        const newF = formula.map(i => {
                            if(i.locked) return i;
                            const w = bestWeights[uIdx++];
                            return {...i, weight: parseFloat(w.toFixed(2))};
                        });
                        setFormula(newF);
                    }
                    setIsSolving(false);
                    setActiveTab('recipe');
                    showToast("计算完成");
                }, 600);
            };

            const handleSave = () => {
                vibrate();
                const nextNum = savedRecipes.length + 1;
                const name = `配方${nextNum}`;
                const newRecipe = { id: Date.now(), name, formula, targets, batchSize, productMode, date: new Date().toLocaleDateString() };
                setSavedRecipes([newRecipe, ...savedRecipes]);
                showToast(`已保存: ${name}`);
            };
            const handleRename = (id) => {
                const r = savedRecipes.find(r => r.id === id);
                const newName = prompt("修改名称", r.name);
                if (newName) setSavedRecipes(savedRecipes.map(r => r.id === id ? { ...r, name: newName } : r));
            };
            const handleDeleteRecipe = (id) => { if(confirm("确定删除？")) { setSavedRecipes(savedRecipes.filter(r => r.id !== id)); showToast("已删除"); } };
            const handleLoadRecipe = (r) => {
                 if(confirm(`加载 "${r.name}"?`)) {
                    setFormula(r.formula); setTargets(r.targets); setBatchSize(r.batchSize); if(r.productMode) setProductMode(r.productMode); setActiveTab('recipe'); showToast("已读取");
                 }
            };

            // --- RENDERERS ---
            const renderAI = () => (
                <div className="space-y-6 animate-slide-up pb-24">
                    <div className="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                        <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2 text-lg"><Icon d={ICONS.Target} size={20} className="text-blue-600"/> 目标设定</h3>
                        <div className="grid grid-cols-2 gap-4 mb-6">
                            {['fat', 'pro'].map(k => (<NumInput key={k} label={`${k.toUpperCase()}%`} value={targets[k]} onChange={e=>setTargets({...targets, [k]:parseFloat(e.target.value)})} />))}
                            <NumInput label="总固 TS%" value={targets.ts} onChange={e=>setTargets({...targets, ts:parseFloat(e.target.value)})} enabled={targets.enableTs} onToggle={()=>setTargets({...targets, enableTs:!targets.enableTs})} />
                            {isYogurt && <NumInput label="甜度 SE" value={targets.se} onChange={e=>setTargets({...targets, se:parseFloat(e.target.value)})} enabled={targets.enableSe} onToggle={()=>setTargets({...targets, enableSe:!targets.enableSe})} />}
                        </div>
                        <div className="flex gap-3"><button onClick={()=>autoSolve('balance')} disabled={isSolving} className="flex-1 h-12 bg-blue-50 text-blue-600 rounded-xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform"><Icon d={ICONS.Wand} size={18}/> 保留锁定，调整其余</button></div>
                        <p className="text-[10px] text-gray-400 text-center mt-3">锁定不需要调整的原料，AI 将自动平衡剩余部分</p>
                    </div>
                    <div className="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                        <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2 text-lg"><Icon d={ICONS.Bolt} size={20} className="text-purple-600"/> 智能生成新配方</h3>
                        <div className="text-xs text-gray-500 mb-3 font-bold">选择原料池:</div>
                        <div className="grid grid-cols-3 gap-3 mb-6">{library.map(ing => (<div key={ing.id} onClick={() => {vibrate(); setGenSelected(prev => prev.includes(ing.id)?prev.filter(i=>i!==ing.id):[...prev,ing.id])}} className={`p-3 rounded-xl text-xs font-bold text-center transition-all border ${genSelected.includes(ing.id)?'bg-purple-50 border-purple-200 text-purple-700':'bg-gray-50 border-transparent text-gray-500'}`}>{ing.name}</div>))}</div>
                        <button onClick={()=>autoSolve('gen')} disabled={isSolving} className="w-full h-14 bg-purple-600 text-white rounded-2xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-purple-200 active:scale-95 transition-transform text-lg"><Icon d={ICONS.Wand} size={20}/> 生成配方</button>
                    </div>
                </div>
            );

            const renderRecipe = () => (
                <div className="space-y-4 animate-slide-up pb-24">
                    <div className="flex justify-between items-center px-1">
                         <div className="flex items-center gap-2 bg-white rounded-lg p-1 border border-gray-100">
                             <button onClick={()=>setViewMode('calc')} className={`text-xs px-3 py-1.5 rounded-md font-bold transition-all ${viewMode==='calc'?'bg-gray-100 text-blue-600':'text-gray-400'}`}>占比</button>
                             <button onClick={()=>setViewMode('cost')} className={`text-xs px-3 py-1.5 rounded-md font-bold transition-all ${viewMode==='cost'?'bg-gray-100 text-green-600':'text-gray-400'}`}>成本</button>
                         </div>
                         <button onClick={balanceWater} className="flex items-center gap-1 text-xs font-bold text-blue-600 bg-blue-50 px-3 py-2 rounded-lg active:scale-95 transition-transform"><Icon d={ICONS.Drop} size={14}/> 一键补水</button>
                    </div>
                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        {formula.length === 0 ? <div className="p-10 text-center text-gray-400 text-sm">暂无原料</div> : formula.map(item => {
                            if (isYogurt && baseView && item.isPost) return null;
                            return (
                                <div key={item.uuid} className={`list-row ${item.locked?'locked-bg':''} ${item.isPost?'post-add-bg':''}`} onClick={() => setEditId(editId===item.uuid?null:item.uuid)}>
                                    <div className="w-24 flex flex-col justify-center pr-1">
                                        <div className={`font-bold text-sm truncate flex items-center gap-1 ${item.locked?'text-gray-400':'text-gray-800'}`}>{item.name}{item.locked && <Icon d={ICONS.Lock} size={10} className="text-amber-500"/>}{item.isPost && <span className="text-[8px] bg-purple-100 text-purple-600 px-1 rounded">后</span>}</div>
                                        <div className="text-[9px] text-gray-400 font-mono mt-0.5">F{item.fat} P{item.protein}</div>
                                    </div>
                                    <div className="flex-1 px-1"><StepperInput value={item.weight} disabled={item.locked} onChange={(e) => !item.locked && updateItem(item.uuid, 'weight', e.target.value)} /></div>
                                    <div className="w-16 flex flex-col items-end justify-center relative pl-1">
                                        <div className="font-bold text-xs text-gray-700 font-mono">{viewMode==='cost' ? `¥${item.price}` : (res.w>0?(item.weight/res.w*100).toFixed(1)+'%':'0%')}</div>
                                        <button onClick={(e)=>{e.stopPropagation(); delItem(item.uuid)}} className="text-gray-300 p-1"><Icon d={ICONS.X} size={14}/></button>
                                        {viewMode==='cost' && <div className="cost-bar" style={{width: `${(item.weight*item.price)/(res.cost||1)*100}%`}}></div>}
                                    </div>
                                    {editId === item.uuid && (
                                        <div className="w-full pt-3 pb-1 animate-slide-down border-t border-gray-50 mt-2" onClick={e=>e.stopPropagation()}>
                                            <div className="flex justify-between mb-2">
                                                <button onClick={()=>updateItem(item.uuid,'locked',!item.locked)} className="text-xs bg-gray-100 px-3 py-1.5 rounded-lg text-gray-600 font-bold">{item.locked?'解锁':'锁定'}</button>
                                                {isYogurt && <button onClick={()=>updateItem(item.uuid,'isPost',!item.isPost)} className="text-xs bg-purple-50 px-3 py-1.5 rounded-lg text-purple-600 font-bold">{item.isPost?'设为基料':'设为后添加'}</button>}
                                            </div>
                                            <div className="grid grid-cols-4 gap-2">
                                                {['fat','protein','ts','price'].map(k=><div key={k} className="bg-gray-50 p-1 rounded text-center"><div className="text-[8px] text-gray-400 uppercase">{k.substr(0,3)}</div><input className="w-full bg-transparent text-center font-bold text-xs" value={item[k]} onChange={e=>updateItem(item.uuid,k,e.target.value)}/></div>)}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 grid grid-cols-4 gap-2 text-center mt-4">
                         <div><div className="text-[10px] text-gray-400 font-bold">FAT</div><div className="text-lg font-black text-gray-800">{res.fat.toFixed(2)}</div></div>
                         <div><div className="text-[10px] text-gray-400 font-bold">PRO</div><div className="text-lg font-black text-gray-800">{res.pro.toFixed(2)}</div></div>
                         <div><div className="text-[10px] text-gray-400 font-bold">TS</div><div className="text-lg font-black text-gray-800">{res.ts.toFixed(2)}</div></div>
                         <div><div className="text-[10px] text-gray-400 font-bold">成本</div><div className="text-lg font-black text-green-600">¥{res.costPerKg.toFixed(1)}</div></div>
                    </div>
                    <button onClick={() => { vibrate(); setShowAdd(true); }} className="mt-4 w-full h-12 rounded-2xl border-2 border-dashed border-blue-200 text-blue-500 font-bold flex items-center justify-center gap-1 active:scale-95 transition-transform bg-white"><Icon d={ICONS.Plus} size={20}/> 添加原料</button>
                </div>
            );

            const renderTools = () => (
                <div className="grid grid-cols-2 gap-3 animate-slide-up pb-24">
                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100" onClick={()=>alert(`需称取菌种: ${(batchSize/1e6*cultureCalc.dcuPerTon/cultureCalc.pouchSize*cultureCalc.pouchWeight).toFixed(4)}g`)}>
                        <div className="w-10 h-10 bg-green-50 text-green-600 rounded-xl flex items-center justify-center mb-2"><Icon d={ICONS.Microscope} size={24}/></div>
                        <div className="font-bold text-sm text-gray-800">菌种计算</div>
                        <div className="text-[10px] text-gray-400 mt-1">点击计算添加量</div>
                    </div>
                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                        <div className="w-10 h-10 bg-orange-50 text-orange-600 rounded-xl flex items-center justify-center mb-2"><Icon d={ICONS.Flask} size={24}/></div>
                        <div className="font-bold text-sm text-gray-800">酸度换算</div>
                        <div className="text-[10px] text-gray-400 mt-1">{acidity.t}°T ≈ {(acidity.t*0.009).toFixed(2)}%</div>
                    </div>
                    <div className="col-span-2 bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <h3 className="font-bold text-sm text-gray-800 mb-3">FOSS 验证</h3>
                        <div className="grid grid-cols-3 gap-2">
                            {['fat','protein','ts'].map(k=><NumInput key={k} label={k.toUpperCase()} value={fossReadings[k]} onChange={e=>setFossReadings({...fossReadings, [k]:parseFloat(e.target.value)})} />)}
                        </div>
                    </div>
                </div>
            );

            const renderFiles = () => (
                <div className="space-y-4 animate-slide-up pb-24">
                     <div className="bg-blue-600 text-white rounded-3xl p-6 shadow-lg flex items-center justify-between active:scale-95 transition-transform" onClick={handleSave}>
                         <div><div className="font-bold text-xl">一键保存当前</div><div className="text-blue-200 text-xs mt-1">自动命名为 配方{savedRecipes.length+1}</div></div>
                         <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center"><Icon d={ICONS.Save} size={24}/></div>
                     </div>
                     <div className="bg-white rounded-3xl p-5 shadow-sm min-h-[300px]">
                         <h3 className="font-bold text-gray-900 mb-4 ml-1">历史存档 ({savedRecipes.length})</h3>
                         {savedRecipes.length===0 && <div className="text-center text-gray-300 py-12">暂无存档</div>}
                         {savedRecipes.map(r => (
                             <div key={r.id} className="flex justify-between items-center p-4 bg-gray-50 rounded-2xl mb-3 border border-gray-100">
                                 <div className="flex-1">
                                     <div className="font-bold text-gray-800 text-lg flex items-center gap-2">{r.name} <button onClick={(e)=>{e.stopPropagation(); handleRename(r.id)}} className="text-gray-400"><Icon d={ICONS.EditPen} size={14}/></button></div>
                                     <div className="text-[10px] text-gray-400 mt-1 font-mono">{r.date}</div>
                                 </div>
                                 <div className="flex gap-3 items-center">
                                     <button onClick={() => handleLoadRecipe(r)} className="text-xs bg-white border border-gray-200 px-4 py-2 rounded-xl font-bold text-blue-600 shadow-sm active:scale-95">读取</button>
                                     <button onClick={(e)=>{e.stopPropagation(); handleDeleteRecipe(r.id)}} className="text-gray-300 hover:text-red-500"><Icon d={ICONS.Trash} size={18}/></button>
                                 </div>
                             </div>
                         ))}
                     </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-[#F0F2F5]">
                    <Toast msg={toast.msg} visible={toast.show} />
                    <header className="fixed top-0 left-0 right-0 z-50 header-glass pt-safe pb-3 px-4">
                        <div className="flex justify-between items-center h-10">
                            <div className="flex bg-gray-100 rounded-lg p-0.5">
                                <button onClick={()=>{vibrate();setProductMode('liquid')}} className={`px-4 py-1.5 text-xs font-bold rounded-md transition-all ${!isYogurt?'bg-white shadow text-blue-600':'text-gray-400'}`}>液奶</button>
                                <button onClick={()=>{vibrate();setProductMode('yogurt')}} className={`px-4 py-1.5 text-xs font-bold rounded-md transition-all ${isYogurt?'bg-white shadow text-purple-600':'text-gray-400'}`}>酸奶</button>
                            </div>
                            <div className={`flex items-center bg-gray-100 rounded-lg px-3 h-9 transition-colors ${isLocked ? 'opacity-60' : ''} w-32`}>
                                <input type="number" value={batchSize} disabled={isLocked} onChange={e => setBatchSize(parseFloat(e.target.value))} className="bg-transparent flex-1 font-mono font-bold text-base text-right outline-none text-gray-800"/>
                                <span className="text-xs font-bold text-gray-400 ml-1">g</span>
                                <button onClick={() => { vibrate(); setIsLocked(!isLocked); }} className="ml-2 text-gray-400"><Icon d={isLocked ? ICONS.Lock : ICONS.Unlock} size={14}/></button>
                            </div>
                            <button onClick={normalize} className="h-9 w-9 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center tap-active shadow-sm border border-blue-100 font-bold text-xs">归</button>
                        </div>
                    </header>

                    <div className="pt-[80px] px-3">
                        {activeTab === 'ai' && renderAI()}
                        {activeTab === 'recipe' && renderRecipe()}
                        {activeTab === 'tools' && renderTools()}
                        {activeTab === 'files' && renderFiles()}
                    </div>

                    <div className="tab-bar">
                        <div className={`tab-item ${activeTab==='ai'?'active':''}`} onClick={() => {vibrate(); setActiveTab('ai')}}><div className="icon-box"><Icon d={ICONS.Brain} size={24}/></div><span className="label">智能</span></div>
                        <div className={`tab-item ${activeTab==='recipe'?'active':''}`} onClick={() => {vibrate(); setActiveTab('recipe')}}><div className="icon-box"><Icon d={ICONS.Flask} size={24}/></div><span className="label">配方</span></div>
                        <div className={`tab-item ${activeTab==='tools'?'active':''}`} onClick={() => {vibrate(); setActiveTab('tools')}}><div className="icon-box"><Icon d={ICONS.Tools} size={24}/></div><span className="label">工具</span></div>
                        <div className={`tab-item ${activeTab==='files'?'active':''}`} onClick={() => {vibrate(); setActiveTab('files')}}><div className="icon-box"><Icon d={ICONS.Folder} size={24}/></div><span className="label">存档</span></div>
                    </div>

                    {showAdd && (
                        <div className="fixed inset-0 z-[60] bg-black/30 backdrop-blur-sm flex items-end" onClick={() => setShowAdd(false)}>
                            <div className="bg-white w-full rounded-t-2xl p-4 h-[60vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                                <div className="font-bold text-lg mb-4 text-center text-gray-800">原料库</div>
                                <div className="grid grid-cols-2 gap-3">{library.map(ing => (<div key={ing.id} onClick={() => addItem(ing)} className="p-3 bg-gray-50 rounded-xl tap-active border border-transparent active:border-blue-200"><div className="font-bold text-gray-800">{ing.name}</div><div className="text-[10px] text-gray-400 mt-1 font-mono">F{ing.fat} P{ing.protein}</div></div>))}</div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
